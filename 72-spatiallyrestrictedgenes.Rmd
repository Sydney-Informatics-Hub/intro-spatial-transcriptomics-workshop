# Analysis example 

Link out directly??? https://swbioinf.github.io/spatialsnippets/e_spatiallyRestrictedGenes.html

<!--
Requires packages:
* Rfast2
* ape
-->

```{r}
library(tidyverse)
library(Seurat)
library(DT)
```

```{r}
so <- readRDS("data/GSE234713_CosMx_IBD_seurat_01_preprocessed_subsampled.RDS" )
```



What genes have a irregular expression across the tissue? These might be localised to a particular region and indicate some spatial activity.


Considering a signle gene, we calculate 'spatial autocorrelation' with the MoransI test.





## Run MoransI once

To run this quickly, going to arbitraily reduce the number of variable features to just 20. 

For real line, would pick all VariableFeatures (or all genes).


```{r}
so <- FindVariableFeatures(so, nfeatures=20)
```

```{r}
the_sample <- 'CD_a'
the_fov    <- 'GSM7473688.CD.a'
so_sample  <- subset(so, tissue_sample == the_sample)
  
```
```{r}
# If the Seurat method above crashes (segfault), a workaround is
# funning FindSpatiallyVariableFeatures at the assay level
so_sample_assay <- so_sample[['RNA']]
tc <- GetTissueCoordinates(so_sample)
rownames(tc)<- tc$cell
# When given an 'assay' FindSpatiallyVariableFeatures returns an assay. Put it back in the seurat object
so_sample[['RNA']] <- FindSpatiallyVariableFeatures(
  so_sample_assay,
  layer = "scale.data",
  spatial.location = tc,
  features = VariableFeatures(so_sample)[1:10], # Just a random few variable genes for testing!
  selection.method = "moransi",
  nfeatures=10 # mark top 10 spatially variable
)
```



```{r}
#Put feature name as a column in the feature metadata
so_sample[["RNA"]]@meta.data$feature <-rownames(so_sample[["RNA"]])
gene_metadata <- so_sample[["RNA"]]@meta.data

gene_metadata_morans <- 
  filter(gene_metadata, !is.na(moransi.spatially.variable.rank)) %>%
  select(feature, 
         MoransI_observed, MoransI_p.value, moransi.spatially.variable,moransi.spatially.variable.rank) %>% 
  arrange(moransi.spatially.variable.rank)
  
DT::datatable(gene_metadata_morans, width = '100%')

```


```{r}
top_genes = gene_metadata_morans$feature[1:3]
top_genes

ImageDimPlot(so_sample, 
             molecules = top_genes, 
             group.by = 'tissue_sample', cols = c("grey30"), # Make all cells grey.
             boundaries = "segmentation",
             border.color = NA, axes = T, crop=TRUE)
```














# Run MoransI on all samples

Could it be that the expression pattern of a gene is disrupted?


```{r}

# Record moransI results for each sample, one by one.
samples <- unique(so@meta.data$tissue_sample)
results_list <- list()
for (the_sample in samples) {
  
  so.sample <- subset( so, subset= tissue_sample == the_sample)

  so.sample.assay <- so.sample[['RNA']]
  tc <- GetTissueCoordinates(so.sample)
  rownames(tc)<- tc$cell
  # When given an 'assay' FindSpatiallyVariableFeatures returns an assay. Put it back in the seurat object.
  so.sample[['RNA']] <- FindSpatiallyVariableFeatures(
    so.sample.assay,
    layer = "scale.data",
    spatial.location = tc,
    features = VariableFeatures(so.sample),
    selection.method = "moransi",
    nfeatures=10 # mark top 10 spatially variable
    )
  # --- end workaround
  
  
  # Format output table
  so.sample[["RNA"]]@meta.data$feature <- rownames(so.sample[["RNA"]])
  gene_metadata <- so.sample[["RNA"]]@meta.data
  results <- 
  select(gene_metadata, 
         feature, 
         MoransI_observed, 
         MoransI_p.value, 
         moransi.spatially.variable,
         moransi.spatially.variable.rank) %>% 
    filter(!is.na(moransi.spatially.variable.rank)) %>% # only tested
    arrange(moransi.spatially.variable.rank) %>%
    mutate(sample = the_sample) %>%
    select(sample, everything())

  
  results_list[[the_sample]] <- results
}

# Collect output result 
results_all <- bind_rows(results_list)



```



```{r fig.width=10}
# unique set of genes that were top 10 morans in any sample
plot_genes <- filter(results_all, moransi.spatially.variable.rank <= 10) %>% pull(feature) %>% unique()
ggplot(filter(results_all, feature %in% plot_genes), aes(x=feature, y=MoransI_observed)) +
  geom_boxplot() +
  geom_point( mapping=aes(col=sample)) +
  theme_bw() +
  ggtitle("MoransI Per sample")
```



## Explore that

```{r}
so.CD_a <- subset( so, subset= tissue_sample == 'CD_a')
so.HC_a <- subset( so, subset= tissue_sample == 'HC_a')

```

IGKC has high autocorrelation all over

```{r}
p1 <- ImageDimPlot(so.CD_a, 
             molecules = 'IGKC', 
             group.by = 'tissue_sample', cols = c("grey30"), # Make all cells grey.
             boundaries = "segmentation", border.color = NA, axes = T, crop=TRUE)
p2 <- ImageDimPlot(so.HC_a, 
             molecules = 'IGKC', 
             group.by = 'tissue_sample', cols = c("grey30"), # Make all cells grey.
             boundaries = "segmentation", border.color = NA, axes = T, crop=TRUE)
p1 + p2 
```



A highly variable gene, with a low(er) spatial autocorrelation
```{r}
p1 <- ImageDimPlot(so.CD_a, 
             molecules = 'CHGA', 
             group.by = 'tissue_sample', cols = c("grey30"), # Make all cells grey.
             boundaries = "segmentation", border.color = NA, axes = T, crop=TRUE)
p2 <- ImageDimPlot(so.HC_a, 
             molecules = 'CHGA', 
             group.by = 'tissue_sample', cols = c("grey30"), # Make all cells grey.
             boundaries = "segmentation", border.color = NA, axes = T, crop=TRUE)
p1 + p2 
```

```{r}
p1 <- ImageDimPlot(so.CD_a, 
             molecules = 'CCL21', 
             group.by = 'tissue_sample', cols = c("grey30"), # Make all cells grey.
             boundaries = "segmentation", border.color = NA, axes = T, crop=TRUE)
p2 <- ImageDimPlot(so.HC_a, 
             molecules = 'CCL21', 
             group.by = 'tissue_sample', cols = c("grey30"), # Make all cells grey.
             boundaries = "segmentation", border.color = NA, axes = T, crop=TRUE)
p1 + p2 
```


Whats going on there? There's a big clump of CCL21
```{r}
ImageDimPlot(so.HC_a, group.by = 'fov')

ImageDimPlot(subset(so.HC_a, fov==4), 
             molecules = 'CCL21', 
             group.by = 'seurat_clusters', alpha=0.3,# Show clusters, but faded 
             boundaries = "segmentation",  border.color = NA, axes = T, crop=TRUE) 
```


Hanging around c4 and c0. CHECK WHAT cluster 0 is - maybe a B cell?
- you'd expect to see some T cells and B cells?
MS4A1 is b cell realted.
```{r}
ImageDimPlot(so.HC_a, 
             molecules = c('CCL21','CD8A','MS4A1'), 
             group.by = 'seurat_clusters', alpha=0.3,# Show clusters, but faded 
             boundaries = "segmentation",  border.color = NA, axes = T, crop=TRUE) 

```


