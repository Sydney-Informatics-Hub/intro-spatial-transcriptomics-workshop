# Quality control and filtering

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load libraries for this step
library(Seurat)
library(tidyverse)
library(here)
```

## Overview

* Basic QC plots + filtering (20min)
* (Negative probes if using cosmx)
* Identify low quality cells

## QC metrics

Read in subsampled seurat object

```{r}
so_path  <- here("data", "GSE234713_CosMx_IBD_seurat_00_raw_subsampled.RDS")
so <- readRDS(so_path)
```


```{r}
# Total counts per cell
ggplot(so@meta.data, aes(x=nCount_RNA, col=orig.ident)) +
  geom_density() +
  scale_x_log10() +
  theme_bw() +
  ggtitle("Transcript Counts per cell")
```
**Exercise:** Display density of negprobes

```{r}
ggplot(so@meta.data, aes(x=nCount_negprobes, col=orig.ident)) +
  geom_density() +
  scale_x_log10() +
  theme_bw() +
  ggtitle("Transcript Counts per cell")
```

Suggest to view QC metrics as co-variates - may lack context if displayed alone:

```{r}
so@meta.data %>%
  ggplot(aes(x = nCount_RNA, y = nFeature_RNA, colour = tissue_sample)) +
  geom_point(alpha = 0.2, size = 0.8) +
  facet_wrap(~tissue_sample) +
  theme_light() +
  theme(legend.position = "none")
```

Point out where bad quality cells would reside

## Spatial

```{r}
unique(so$orig.ident)
```

```{r}
ImageFeaturePlot(so, fov = "GSM7473684_HC_c", features = "nCount_RNA")
```

```{r}
ImageFeaturePlot(so, fov = "GSM7473684_HC_c", features = "nCount_negprobes")
```

## FilterNegative counts per cell

Key metrics:

- `so$percent_neg`: The percentage of negative probes per cell
- `so$mean_neg`: The average negative probes per cell

```{r}
so$percent_neg <- (so$nCount_negprobes / (so$nCount_RNA + so$nCount_negprobes)) * 100

# Join layers to calculate average_neg
so@assays$negprobes <- JoinLayers(so@assays$negprobes)
so$mean_neg <- colMeans(so@assays$negprobes) # Only defined first sample
```

```{r}
# Discuss difference with Xenium - xenium lower counts, lower background.
max_pc_neg         <- 5

ggplot(so@meta.data, aes(y=mean_neg, x=nCount_RNA)) +
  geom_point(alpha=0.1) +
  scale_x_log10() +
  theme_bw() +
  ggtitle("Negative probes vs counts")

min_count_per_cell <- 1
ggplot(so@meta.data, aes(x = nCount_RNA, y = mean_neg)) +
  geom_hline(yintercept = max_pc_neg, lty=3, colour = "red") +
  geom_vline(xintercept = min_count_per_cell, lty=3, colour = "red") +
  geom_point(pch=3, alpha=0.1) +
  scale_x_log10() +
  theme_bw() +
  ggtitle("Negative probes vs counts")
```

```{r}
ImageFeaturePlot(so, fov = unique(so$orig.ident), features = c("percent_neg"))
```

